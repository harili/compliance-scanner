<!DOCTYPE html>
<html>
<head>
    <title>Debug Scan Execution - ComplianceScannerPro</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #0d6efd; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        .result { margin-top: 20px; padding: 10px; border-radius: 4px; }
        .success { background: #d1edff; border: 1px solid #0d6efd; }
        .error { background: #f8d7da; border: 1px solid #dc3545; }
        .warning { background: #fff3cd; border: 1px solid #ffc107; }
        .log-container { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .step { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 4px; }
        .scan-status { font-weight: bold; padding: 5px 10px; border-radius: 4px; }
        .status-pending { background: #ffc107; color: #000; }
        .status-running { background: #17a2b8; color: #fff; }
        .status-completed { background: #28a745; color: #fff; }
        .status-failed { background: #dc3545; color: #fff; }
    </style>
</head>
<body>
    <h1>üîß Debug Scan Execution - ComplianceScannerPro</h1>
    
    <div class="form-group">
        <label>URL de l'application:</label>
        <input type="text" id="baseUrl" value="https://localhost:7293" placeholder="https://localhost:7293">
    </div>

    <div class="step">
        <h2>1. Test de connexion API</h2>
        <button onclick="testConnection()">Tester la connexion</button>
        <div id="connectionResult"></div>
    </div>

    <div class="step">
        <h2>2. Lancer un scan de test</h2>
        <div class="form-group">
            <label>Website ID:</label>
            <input type="number" id="websiteId" value="1" placeholder="1">
        </div>
        <button onclick="startTestScan()">D√©marrer scan de test</button>
        <div id="scanResult"></div>
    </div>

    <div class="step">
        <h2>3. Suivi temps r√©el du scan</h2>
        <button onclick="startMonitoring()">D√©marrer le monitoring</button>
        <button onclick="stopMonitoring()" class="danger">Arr√™ter le monitoring</button>
        <div id="monitoringResult"></div>
        <div id="scanLogs" class="log-container" style="display: none;"></div>
    </div>

    <div class="step">
        <h2>4. Test direct des services</h2>
        <div class="form-group">
            <label>URL √† tester:</label>
            <input type="text" id="testUrl" value="https://example.com" placeholder="https://example.com">
        </div>
        <button onclick="testWebCrawler()">Test WebCrawler</button>
        <button onclick="testAccessibilityAnalyzer()">Test AccessibilityAnalyzer</button>
        <button onclick="testFullPipeline()">Test Pipeline Complet</button>
        <div id="serviceTestResult"></div>
    </div>

    <div class="step">
        <h2>5. D√©tails scan approfondi</h2>
        <div class="form-group">
            <label>Scan ID √† analyser:</label>
            <input type="text" id="detailScanId" placeholder="Entrez un Scan ID">
        </div>
        <button onclick="getScanDetails()">Analyser Scan</button>
        <div id="scanDetailsResult"></div>
    </div>

    <script>
        let monitoringInterval = null;
        let currentScanId = null;

        async function testConnection() {
            const baseUrl = document.getElementById('baseUrl').value;
            const resultDiv = document.getElementById('connectionResult');
            
            try {
                const response = await fetch(`${baseUrl}/api/v1/websites`);
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="result success">‚úÖ Connexion OK - Status: ${response.status}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="result error">‚ùå Erreur de connexion - Status: ${response.status}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Erreur de connexion: ${error.message}</div>`;
            }
        }

        async function startTestScan() {
            const baseUrl = document.getElementById('baseUrl').value;
            const websiteId = document.getElementById('websiteId').value;
            const resultDiv = document.getElementById('scanResult');
            
            try {
                resultDiv.innerHTML = `<div class="result warning">‚è≥ D√©marrage du scan...</div>`;
                
                const response = await fetch(`${baseUrl}/api/v1/scans/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        websiteId: parseInt(websiteId)
                    })
                });

                const result = await response.json();
                
                if (result.success && result.data) {
                    currentScanId = result.data.scanId;
                    resultDiv.innerHTML = `
                        <div class="result success">
                            ‚úÖ Scan d√©marr√© avec succ√®s!<br>
                            <strong>Scan ID:</strong> ${result.data.scanId}<br>
                            <strong>Status:</strong> <span class="scan-status status-${result.data.status.toLowerCase()}">${result.data.status}</span><br>
                            <strong>D√©marr√©:</strong> ${new Date(result.data.startedAt).toLocaleString()}
                        </div>
                    `;
                } else {
                    const errorMsg = result.errors?.length > 0 ? result.errors[0] : result.message || 'Erreur inconnue';
                    resultDiv.innerHTML = `<div class="result error">‚ùå Erreur: ${errorMsg}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Erreur de communication: ${error.message}</div>`;
            }
        }

        async function startMonitoring() {
            if (!currentScanId) {
                document.getElementById('monitoringResult').innerHTML = 
                    `<div class="result error">‚ùå Aucun scan en cours. D√©marrez d'abord un scan.</div>`;
                return;
            }

            const baseUrl = document.getElementById('baseUrl').value;
            const resultDiv = document.getElementById('monitoringResult');
            const logsDiv = document.getElementById('scanLogs');
            
            logsDiv.style.display = 'block';
            logsDiv.innerHTML = '<h4>üìä Logs de monitoring:</h4>';
            
            resultDiv.innerHTML = `<div class="result warning">‚è≥ Monitoring en cours du scan ${currentScanId}...</div>`;

            let attemptCount = 0;
            const maxAttempts = 120; // 10 minutes √† 5s d'intervalle

            monitoringInterval = setInterval(async () => {
                attemptCount++;
                
                try {
                    const response = await fetch(`${baseUrl}/api/v1/scans/${currentScanId}/status`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        if (result.success && result.data) {
                            const scan = result.data;
                            const timestamp = new Date().toLocaleTimeString();
                            
                            logsDiv.innerHTML += `
                                <div>[${timestamp}] Status: <span class="scan-status status-${scan.status.toLowerCase()}">${scan.status}</span> | 
                                Pages: ${scan.pagesScanned || 0} | 
                                Probl√®mes: ${scan.totalIssues || 0}</div>
                            `;
                            
                            // Faire d√©filer vers le bas
                            logsDiv.scrollTop = logsDiv.scrollHeight;
                            
                            if (scan.status === 'Completed') {
                                stopMonitoring();
                                resultDiv.innerHTML = `
                                    <div class="result success">
                                        ‚úÖ Scan termin√© avec succ√®s!<br>
                                        <strong>Score:</strong> ${scan.score}/100<br>
                                        <strong>Grade:</strong> ${scan.grade}<br>
                                        <strong>Pages scann√©es:</strong> ${scan.pagesScanned}<br>
                                        <strong>Probl√®mes trouv√©s:</strong> ${scan.totalIssues}
                                    </div>
                                `;
                                return;
                            } else if (scan.status === 'Failed') {
                                stopMonitoring();
                                resultDiv.innerHTML = `
                                    <div class="result error">
                                        ‚ùå Scan √©chou√©!<br>
                                        <strong>Erreur:</strong> ${scan.errorMessage || 'Erreur inconnue'}
                                    </div>
                                `;
                                return;
                            }
                        }
                    } else {
                        logsDiv.innerHTML += `<div class="error">[${new Date().toLocaleTimeString()}] Erreur API: ${response.status}</div>`;
                    }
                } catch (error) {
                    logsDiv.innerHTML += `<div class="error">[${new Date().toLocaleTimeString()}] Erreur: ${error.message}</div>`;
                }
                
                if (attemptCount >= maxAttempts) {
                    stopMonitoring();
                    resultDiv.innerHTML = `<div class="result error">‚ùå Timeout: Le scan n'a pas termin√© apr√®s 10 minutes.</div>`;
                }
            }, 5000); // Toutes les 5 secondes
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
        }

        async function testWebCrawler() {
            const baseUrl = document.getElementById('baseUrl').value;
            const testUrl = document.getElementById('testUrl').value;
            const resultDiv = document.getElementById('serviceTestResult');
            
            try {
                resultDiv.innerHTML = `<div class="result warning">‚è≥ Test du WebCrawler...</div>`;
                
                const response = await fetch(`${baseUrl}/api/v1/debug/test-crawler`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: testUrl })
                });

                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            ‚úÖ WebCrawler fonctionne!<br>
                            <strong>URLs trouv√©es:</strong> ${result.data.urlCount}<br>
                            <strong>Temps:</strong> ${result.data.duration}ms
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="result error">‚ùå Erreur WebCrawler: ${result.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Erreur de communication: ${error.message}</div>`;
            }
        }

        async function testAccessibilityAnalyzer() {
            const baseUrl = document.getElementById('baseUrl').value;
            const testUrl = document.getElementById('testUrl').value;
            const resultDiv = document.getElementById('serviceTestResult');
            
            try {
                resultDiv.innerHTML = `<div class="result warning">‚è≥ Test de l'AccessibilityAnalyzer...</div>`;
                
                const response = await fetch(`${baseUrl}/api/v1/debug/test-analyzer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: testUrl })
                });

                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            ‚úÖ AccessibilityAnalyzer fonctionne!<br>
                            <strong>Probl√®mes trouv√©s:</strong> ${result.data.issueCount}<br>
                            <strong>Temps:</strong> ${result.data.duration}ms
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="result error">‚ùå Erreur AccessibilityAnalyzer: ${result.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Erreur de communication: ${error.message}</div>`;
            }
        }

        async function testFullPipeline() {
            const baseUrl = document.getElementById('baseUrl').value;
            const testUrl = document.getElementById('testUrl').value;
            const resultDiv = document.getElementById('serviceTestResult');
            
            try {
                resultDiv.innerHTML = `<div class="result warning">‚è≥ Test du pipeline complet...</div>`;
                
                const response = await fetch(`${baseUrl}/api/v1/debug/test-full-pipeline`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: testUrl })
                });

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    let stepsHtml = '<h4>üìã √âtapes du pipeline:</h4>';
                    data.steps.forEach(step => {
                        const icon = step.success ? '‚úÖ' : '‚ùå';
                        stepsHtml += `<div>${icon} ${step.step}: ${step.details} (${step.duration}ms)</div>`;
                    });
                    
                    resultDiv.innerHTML = `
                        <div class="result success">
                            ‚úÖ Pipeline complet termin√©!<br>
                            <strong>Temps total:</strong> ${data.totalDuration}ms<br>
                            <strong>URLs trouv√©es:</strong> ${data.summary.urlsFound}<br>
                            <strong>Probl√®mes trouv√©s:</strong> ${data.summary.issuesFound}<br>
                            ${stepsHtml}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="result error">‚ùå Erreur Pipeline: ${result.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Erreur de communication: ${error.message}</div>`;
            }
        }

        async function getScanDetails() {
            const baseUrl = document.getElementById('baseUrl').value;
            const scanId = document.getElementById('detailScanId').value;
            const resultDiv = document.getElementById('scanDetailsResult');
            
            if (!scanId.trim()) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Veuillez entrer un Scan ID</div>`;
                return;
            }
            
            try {
                resultDiv.innerHTML = `<div class="result warning">‚è≥ R√©cup√©ration des d√©tails du scan...</div>`;
                
                const response = await fetch(`${baseUrl}/api/v1/debug/scan-details/${scanId}`);
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    const scan = data.scan;
                    const website = data.website;
                    const stats = data.statistics;
                    
                    let statusClass = '';
                    switch(scan.status.toLowerCase()) {
                        case 'pending': statusClass = 'status-pending'; break;
                        case 'running': statusClass = 'status-running'; break;
                        case 'completed': statusClass = 'status-completed'; break;
                        case 'failed': statusClass = 'status-failed'; break;
                    }
                    
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h4>üìä D√©tails du scan ${scan.scanId}</h4>
                            
                            <h5>üîç Informations g√©n√©rales:</h5>
                            <p><strong>Status:</strong> <span class="scan-status ${statusClass}">${scan.status}</span></p>
                            <p><strong>D√©marr√©:</strong> ${new Date(scan.startedAt).toLocaleString()}</p>
                            ${scan.completedAt ? `<p><strong>Termin√©:</strong> ${new Date(scan.completedAt).toLocaleString()}</p>` : ''}
                            <p><strong>Pages scann√©es:</strong> ${scan.pagesScanned || 'N/A'}</p>
                            ${scan.score ? `<p><strong>Score:</strong> ${scan.score}/100</p>` : ''}
                            ${scan.grade ? `<p><strong>Grade:</strong> ${scan.grade}</p>` : ''}
                            ${scan.errorMessage ? `<p><strong>Erreur:</strong> ${scan.errorMessage}</p>` : ''}
                            
                            ${website ? `
                                <h5>üåê Site web:</h5>
                                <p><strong>Nom:</strong> ${website.name}</p>
                                <p><strong>URL:</strong> ${website.url}</p>
                                <p><strong>Actif:</strong> ${website.isActive ? 'Oui' : 'Non'}</p>
                                <p><strong>Profondeur max:</strong> ${website.maxDepth}</p>
                                <p><strong>Sous-domaines:</strong> ${website.includeSubdomains ? 'Oui' : 'Non'}</p>
                            ` : ''}
                            
                            <h5>üìà Statistiques:</h5>
                            <p><strong>Total probl√®mes:</strong> ${stats.totalIssues}</p>
                            <p><strong>Par s√©v√©rit√©:</strong> ${Object.entries(stats.issuesBySeverity).map(([k,v]) => `${k}: ${v}`).join(', ')}</p>
                            
                            ${data.issues.length > 0 ? `
                                <h5>üö® Exemples de probl√®mes:</h5>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${data.issues.map(issue => `
                                        <div style="border: 1px solid #ddd; margin: 5px 0; padding: 5px; border-radius: 3px;">
                                            <strong>${issue.title}</strong> (${issue.severity})<br>
                                            <small>${issue.pageUrl}</small><br>
                                            <small>R√®gle: ${issue.rgaaRule}</small><br>
                                            ${issue.description || 'Pas de description'}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="result error">‚ùå ${result.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Erreur de communication: ${error.message}</div>`;
            }
        }

        // Auto-test de connexion au chargement
        window.onload = function() {
            testConnection();
        };
    </script>
</body>
</html>